<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>行事曆</title>
  <link rel="stylesheet" href="forum.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-3 col-lg-2 sidebar">
        <label class="burger" for="burger">
          <div class="inside">
            <input type="checkbox" id="burger">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </label>
        <div class="img">
          <img src="239333290_320748733171736_6443187548162698055_n.png" title="帥啊~~" class="img1">
        </div>
        
        <div class="hi"><h2>資安社</h2></div>
        <div class="color-change">
          <ul>  
            <li><a href="index.html" class="button">首頁</a></li>
            <li><a href="courses.html" class="button">幹部資訊</a></li>
            <li><a href="forum.html" class="button">討論區</a></li>
            <li><a href="calendar.html" class="button">課程資訊</a></li>
          </ul>
        </div>
      </nav>
      
      <main class="col-md-9 col-lg-10 main-content">
        <h1>討論區</h1>

    <div>
        <textarea class="message-input" placeholder="輸入您的訊息..."></textarea>
        <div class="preview-container" id="message-preview"></div>
        <input type="file" id="message-file" class="file-input" accept="image/*,.pdf,.doc,.docx,.txt">
        <label for="message-file" class="file-input-label">選擇文件或照片</label>
        <button class="message-button" onclick="addMessage()">發佈訊息</button>
    </div>

    <div id="message-list"></div>

    <div id="modal" class="modal">
        <span class="close">&times;</span>
        <div class="modal-content" id="modal-content"></div>
    </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="app.js"></script>
  <script>
    let messages = JSON.parse(localStorage.getItem('messages')) || [];
    let messageId = messages.length ? Math.max(...messages.map(m => m.id)) + 1 : 0;

    function saveMessages() {
        localStorage.setItem('messages', JSON.stringify(messages));
    }

    function loadMessages() {
        const messageList = document.getElementById('message-list');
        messageList.innerHTML = '';
        messages.forEach(message => {
            displayMessage(message);
        });
    }

    function displayMessage(message) {
        const messageList = document.getElementById('message-list');
        const messageContainer = document.createElement('div');
        messageContainer.className = 'message-container';
        messageContainer.id = `message-${message.id}`;
        
        let fileContent = '';
        if (message.file) {
            fileContent = createFilePreview(message.file, message.id);
        }

        messageContainer.innerHTML = `
            <button class="delete-button" onclick="deleteMessage(${message.id})">刪除</button>
            <div class="message-text">${message.text}</div>
            ${fileContent}
            <div class="reply-form">
                <textarea class="reply-input" placeholder="回覆此訊息..."></textarea>
                <div class="preview-container" id="reply-preview-${message.id}"></div>
                <input type="file" id="reply-file-${message.id}" class="file-input" accept="image/*,.pdf,.doc,.docx,.txt">
                <label for="reply-file-${message.id}" class="file-input-label">選擇文件或照片</label>
                <button class="reply-button" onclick="addReply(${message.id})">回覆</button>
            </div>
            <div class="reply-list" id="reply-list-${message.id}"></div>
        `;
        messageList.appendChild(messageContainer);
        message.replies.forEach(reply => displayReply(message.id, reply));

        document.getElementById(`reply-file-${message.id}`).addEventListener('change', function(event) {
            handleFileSelect(event, `reply-preview-${message.id}`);
        });
    }

    function displayReply(parentId, reply) {
        const replyList = document.getElementById(`reply-list-${parentId}`);
        const replyContainer = document.createElement('div');
        replyContainer.className = 'reply-container';
        replyContainer.id = `reply-${reply.id}`;

        let fileContent = '';
        if (reply.file) {
            fileContent = createFilePreview(reply.file, `${parentId}-${reply.id}`);
        }

        replyContainer.innerHTML = `
            <button class="delete-button" onclick="deleteReply(${parentId}, ${reply.id})">刪除</button>
            <div class="reply-text">${reply.text}</div>
            ${fileContent}
        `;
        replyList.appendChild(replyContainer);
    }

    function createFilePreview(file, id) {
        if (file.type.startsWith('image/')) {
            return `<div class="preview-container" onclick="openModal('${file.content}', true)">
                <img src="${file.content}" alt="Uploaded image" class="preview-image">
                <span class="preview-name">${file.name}</span>
            </div>`;
        } else {
            const extension = file.name.split('.').pop().toUpperCase();
            return `<div class="preview-container" onclick="openModal('${file.content}', false, '${file.name}')">
                <div class="preview-icon">${extension}</div>
                <span class="preview-name">${file.name}</span>
            </div>`;
        }
    }

    async function addMessage() {
        const messageText = document.querySelector('.message-input').value.trim();
        const fileInput = document.getElementById('message-file');
        if (messageText === '' && fileInput.files.length === 0) return;

        let file = null;
        if (fileInput.files.length > 0) {
            file = await processFile(fileInput.files[0]);
        }

        const message = {
            id: messageId++,
            text: messageText,
            file: file,
            replies: []
        };

        messages.push(message);
        saveMessages();
        displayMessage(message);
        document.querySelector('.message-input').value = '';
        fileInput.value = '';
        document.getElementById('message-preview').innerHTML = '';
    }

    async function addReply(parentId) {
        const replyInput = document.querySelector(`#message-${parentId} .reply-input`);
        const replyText = replyInput.value.trim();
        const fileInput = document.getElementById(`reply-file-${parentId}`);
        if (replyText === '' && fileInput.files.length === 0) return;

        let file = null;
        if (fileInput.files.length > 0) {
            file = await processFile(fileInput.files[0]);
        }

        const reply = {
            id: Date.now(),
            text: replyText,
            file: file
        };

        const message = messages.find(m => m.id === parentId);
        message.replies.push(reply);
        saveMessages();
        displayReply(parentId, reply);
        replyInput.value = '';
        fileInput.value = '';
        document.getElementById(`reply-preview-${parentId}`).innerHTML = '';
    }

    async function processFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                resolve({
                    name: file.name,
                    type: file.type,
                    content: event.target.result
                });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    function deleteMessage(id) {
        messages = messages.filter(message => message.id !== id);
        saveMessages();
        document.getElementById(`message-${id}`).remove();
    }

    function deleteReply(parentId, replyId) {
        const message = messages.find(m => m.id === parentId);
        message.replies = message.replies.filter(reply => reply.id !== replyId);
        saveMessages();
        document.getElementById(`reply-${replyId}`).remove();
    }

    function handleFileSelect(event, previewId) {
        const file = event.target.files[0];
        if (!file) return;

        const previewContainer = document.getElementById(previewId);
        previewContainer.innerHTML = '';

        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.classList.add('preview-image');
            img.file = file;

            const reader = new FileReader();
            reader.onload = (function(aImg) { return function(e) { aImg.src = e.target.result; }; })(img);
            reader.readAsDataURL(file);

            previewContainer.appendChild(img);
        } else {
            const extension = file.name.split('.').pop().toUpperCase();
            previewContainer.innerHTML = `
                <div class="preview-icon">${extension}</div>
                <span class="preview-name">${file.name}</span>
            `;
        }
    }

    function openModal(content, isImage, fileName) {
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        
        if (isImage) {
            modalContent.innerHTML = `<img src="${content}" alt="Full size image" class="modal-image">`;
        } else {
            modalContent.innerHTML = `
                <div class="modal-file">
                    <h2>${fileName}</h2>
                    <p>文件類型: ${fileName.split('.').pop().toUpperCase()}</p>
                    <a href="${content}" download="${fileName}" class="message-button">下載文件</a>
                </div>
            `;
        }
        
        modal.style.display = "flex";
    }

    document.querySelector('.close').onclick = function() {
        document.getElementById('modal').style.display = "none";
    }

    window.onclick = function(event) {
        const modal = document.getElementById('modal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    window.onload = function() {
        loadMessages();
        document.getElementById('message-file').addEventListener('change', function(event) {
            handleFileSelect(event, 'message-preview');
        });
    };
</script>
</body>
</html>
